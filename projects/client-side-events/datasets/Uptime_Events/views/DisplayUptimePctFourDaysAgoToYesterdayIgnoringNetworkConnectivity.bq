#standardSQL

SELECT
  date,
  display_id,
  avg(result) * 100 AS day_uptime_pct
FROM (
  SELECT
    DATE(ts) date,
    display_id,
    CASE
      WHEN scheduled = FALSE THEN NULL
      WHEN showing = TRUE THEN 1
      ELSE 0
    END result
  FROM
    `client-side-events.Uptime_Events.EventsPastFourDays`
  WHERE
    DATE(ts) != CURRENT_DATE())
GROUP BY
  date,
  display_id
ORDER BY
  date DESC
